#!/usr/bin/python3

import os
import requests
import time
import dbus

reference_url = os.environ['REFERENCE_URL']
local_url = os.environ.get('LOCAL_URL', 'http://localhost:8545')
threshold = int(os.environ.get('THRESHOLD', '20'))

data = {'jsonrpc': '2.0', 'method': 'eth_blockNumber', 'params': [], 'id': 1}

def get_systemd_manager():
    bus = dbus.SystemBus(private=True)
    systemd1 = bus.get_object('org.freedesktop.systemd1', '/org/freedesktop/systemd1')
    manager = dbus.Interface(systemd1, 'org.freedesktop.systemd1.Manager')
    return bus, manager

bus, manager = get_systemd_manager()
is_restarted = False

while True:
    try:
        ret0 = requests.post(reference_url, json=data, timeout=(5, 5))
        ret1 = requests.post(local_url, json=data, timeout=(5, 5))

        diff = int(ret0.json()['result'], 16) - int(ret1.json()['result'], 16)

        if diff > threshold:
            print(f"{diff} restarting Erigon")
            if not is_restarted:
                manager.RestartUnit('erigon.service', 'fail')
            is_restarted = True
        else:
            is_restarted = False
            print(f"{diff}")

    except requests.exceptions.Timeout:
        print("Timed out")
    except dbus.exceptions.DBusException as e:
        print(f"D-Bus error, reinitializing: {e}")
        try:
            bus.close()
        except Exception:
            pass
        bus, manager = get_systemd_manager()
    except Exception as e:
        print(f"Unknown exception {e}")

    time.sleep(60)
